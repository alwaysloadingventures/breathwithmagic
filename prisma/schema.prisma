generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String            @id @default(cuid())
  clerkId          String            @unique
  email            String
  name             String?
  avatarUrl        String?
  stripeCustomerId String?
  role             UserRole          @default(user)
  isAdmin          Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  contentViews     ContentView[]
  creatorProfile   CreatorProfile?
  emailPreferences EmailPreferences?
  follows          Follow[]          @relation("UserFollows")
  receivedMessages Message[]         @relation("ReceivedMessages")
  sentMessages     Message[]         @relation("SentMessages")
  notifications    Notification[]
  subscriptions    Subscription[]    @relation("UserSubscriptions")
  onboarding       UserOnboarding?
  reports          ContentReport[]

  @@index([clerkId])
  @@index([stripeCustomerId])
}

model CreatorProfile {
  id                       String                @id @default(cuid())
  userId                   String                @unique
  handle                   String                @unique @db.VarChar(30)
  displayName              String
  bio                      String?
  avatarUrl                String?
  coverImageUrl            String?
  category                 CreatorCategory
  subscriptionPrice        SubscriptionPriceTier @default(TIER_1000)
  trialEnabled             Boolean               @default(true)
  dmEnabled                Boolean               @default(true)
  stripeAccountId          String?
  stripeOnboardingComplete Boolean               @default(false)
  status                   CreatorStatus         @default(pending_setup)
  isVerified               Boolean               @default(false)
  isFeatured               Boolean               @default(false)
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  content                  Content[]
  user                     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  followers                Follow[]              @relation("CreatorFollowers")
  programs                 Program[]
  subscriptions            Subscription[]        @relation("CreatorSubscriptions")

  @@index([handle])
  @@index([category, status])
  @@index([isFeatured])
  @@index([userId])
}

model Program {
  id           String         @id @default(cuid())
  creatorId    String
  title        String
  description  String?
  thumbnailUrl String?
  isFree       Boolean        @default(false)
  sortOrder    Int            @default(0)
  publishedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  content      Content[]
  creator      CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, publishedAt])
}

model Content {
  id           String          @id @default(cuid())
  creatorId    String
  programId    String?
  type         ContentType
  title        String
  description  String?
  mediaUrl     String?
  thumbnailUrl String?
  duration     Int?
  isFree       Boolean         @default(false)
  status       ContentStatus   @default(draft)
  sortOrder    Int?
  publishedAt  DateTime?
  deletedAt    DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  creator      CreatorProfile  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  program      Program?        @relation(fields: [programId], references: [id])
  views        ContentView[]
  reports      ContentReport[]

  @@index([creatorId, status, publishedAt])
  @@index([programId, sortOrder])
  @@index([type, publishedAt])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  creatorId            String
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus @default(active)
  priceAtPurchase      Int
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  creator              CreatorProfile     @relation("CreatorSubscriptions", fields: [creatorId], references: [id], onDelete: Cascade)
  user                 User               @relation("UserSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId, status])
  @@index([creatorId, status])
  @@index([status, currentPeriodEnd])
}

model Follow {
  id        String         @id @default(cuid())
  userId    String
  creatorId String
  createdAt DateTime       @default(now())
  creator   CreatorProfile @relation("CreatorFollowers", fields: [creatorId], references: [id], onDelete: Cascade)
  user      User           @relation("UserFollows", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId])
  @@index([creatorId])
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  content     String
  isRead      Boolean  @default(false)
  isBroadcast Boolean  @default(false)
  createdAt   DateTime @default(now())
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([receiverId, isRead, createdAt])
  @@index([senderId, createdAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}

model ContentView {
  id            String    @id @default(cuid())
  contentId     String
  userId        String
  watchDuration Int?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  content       Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contentId, createdAt])
  @@index([userId, createdAt])
}

model ProcessedWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  processedAt DateTime @default(now())

  @@index([eventId])
}

model UserOnboarding {
  id                         String           @id @default(cuid())
  userId                     String           @unique
  status                     OnboardingStatus @default(NOT_STARTED)
  currentStep                Int              @default(0)
  startedAt                  DateTime?
  completedAt                DateTime?
  primaryGoal                String?
  experienceLevel            String?
  preferredTime              String?
  timeCommitment             String?
  interestedModalities       String[]
  consentGiven               Boolean          @default(false)
  consentVersion             String?
  consentTimestamp           DateTime?
  recommendedCreatorIds      String[]
  recommendationsGeneratedAt DateTime?
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  user                       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model EmailPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email preferences (all default true)
  newContent          Boolean  @default(true)
  newMessage          Boolean  @default(true)
  trialReminders      Boolean  @default(true)
  paymentAlerts       Boolean  @default(true)
  subscriptionUpdates Boolean  @default(true)

  // Marketing (default false)
  marketing           Boolean  @default(false)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
}

enum UserRole {
  user
  creator
}

enum CreatorCategory {
  Breathwork
  Yoga
  Meditation
  Mindfulness
  Somatic
  SoundHealing
  Movement
  Coaching
  Sleep
  StressRelief
}

enum SubscriptionPriceTier {
  TIER_500
  TIER_1000
  TIER_2000
  TIER_3000
}

enum CreatorStatus {
  pending_setup
  active
  suspended
  deactivated
}

enum ContentType {
  video
  audio
  text
}

enum ContentStatus {
  draft
  published
  archived
  deleted
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
}

enum NotificationType {
  new_content
  new_message
  subscription_renewed
  trial_ending
  payment_failed
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  SKIPPED
  COMPLETED
}

enum ReportReason {
  INAPPROPRIATE
  SPAM
  HARASSMENT
  COPYRIGHT
  MISLEADING
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}

model ContentReport {
  id          String       @id @default(cuid())
  contentId   String
  content     Content      @relation(fields: [contentId], references: [id], onDelete: Cascade)
  reporterId  String
  reporter    User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reason      ReportReason
  description String?      @db.Text
  status      ReportStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([contentId, reporterId])
  @@index([status, createdAt])
  @@index([contentId])
  @@index([reporterId])
}
